<section class="section text-center">
  <div class="columns">
    <div class="column">
      <h2 class="is-size-2" class="mb-12 text-5xl font-bold tracking-tight md:text-6xl xl:text-7xl text-purple-600">Encriptar</h2>
      <div class="field">
        <label class="label">Contraseña</label>
        <div class="control">
          <input id="contraseñaEncriptar" class="input" type="password" placeholder="Escribe la contraseña">
        </div>
      </div>
      <div class="field">
        <label class="label">Información para encriptar</label>
        <div class="control">
          <textarea id="informacionEncriptar" class="textarea" placeholder="Alguna cadena, JSON, etcétera"></textarea>
        </div>
      </div>
      <button class="button is-success inline-flex items-center rounded-full bg-purple-600 px-6 py-2.5 text-lg font-medium leading-normal text-white hover:bg-purple-700 hover:shadow-[0_8px_9px_-4px_rgba(59,113,202,0.3),0_4px_18px_0_rgba(59,113,202,0.2)] focus:bg-purple-700 focus:shadow-[0_8px_9px_-4px_rgba(59,113,202,0.3),0_4px_18px_0_rgba(59,113,202,0.2)] focus:outline-none focus:ring-0 active:bg-purple-800 active:shadow-[0_8px_9px_-4px_rgba(59,113,202,0.3),0_4px_18px_0_rgba(59,113,202,0.2)]" id="botonEncriptar">Encriptar</button>
      <div class="field">
        <label class="label">Resultado</label>
        <div class="control">
          <textarea readonly id="resultadoEncriptacion" class="textarea"></textarea>
        </div>
      </div>
    </div>
    <div class="column">
      <h2 class="is-size-2" class="mb-12 text-5xl font-bold tracking-tight md:text-6xl xl:text-7xl text-purple-600">Desencriptar</h2>
      <div class="field">
        <label class="label">Contraseña</label>
        <div class="control">
          <input class="input" id="contraseñaDesencriptar" type="password" placeholder="Escribe la contraseña">
        </div>
      </div>
      <div class="field">
        <label class="label" >Información para desencriptar, en base64</label>
        <div class="control">
          <textarea class="textarea" id="informacionDesencriptar" placeholder="La cadena cifrada previamente con este programa"></textarea>
        </div>
      </div>
      <button class="button is-success inline-flex items-center rounded-full bg-purple-600 px-6 py-2.5 text-lg font-medium leading-normal text-white hover:bg-purple-700 hover:shadow-[0_8px_9px_-4px_rgba(59,113,202,0.3),0_4px_18px_0_rgba(59,113,202,0.2)] focus:bg-purple-700 focus:shadow-[0_8px_9px_-4px_rgba(59,113,202,0.3),0_4px_18px_0_rgba(59,113,202,0.2)] focus:outline-none focus:ring-0 active:bg-purple-800 active:shadow-[0_8px_9px_-4px_rgba(59,113,202,0.3),0_4px_18px_0_rgba(59,113,202,0.2)]" id="botonDesencriptar">Desencriptar</button>
      <div class="field">
        <label class="label">Resultado</label>
        <div class="control">
          <textarea readonly id="resultadoDesencriptacion" class="textarea"></textarea>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const $contraseñaEncriptar = document.querySelector("#contraseñaEncriptar"),
      $informacionEncriptar = document.querySelector("#informacionEncriptar"),
      $resultadoEncriptacion = document.querySelector("#resultadoEncriptacion"),
      $botonEncriptar = document.querySelector("#botonEncriptar"),
      $contraseñaDesencriptar = document.querySelector("#contraseñaDesencriptar"),
      $informacionDesencriptar = document.querySelector("#informacionDesencriptar"),
      $resultadoDesencriptacion = document.querySelector("#resultadoDesencriptacion"),
      $botonDesencriptar = document.querySelector("#botonDesencriptar");
  
    const bufferABase64 = buffer => btoa(String.fromCharCode(...new Uint8Array(buffer)));
    const base64ABuffer = buffer => Uint8Array.from(atob(buffer), c => c.charCodeAt(0));
    const LONGITUD_SAL = 16;
    const LONGITUD_VECTOR_INICIALIZACION = LONGITUD_SAL;
    const derivacionDeClaveBasadaEnContraseña = async (contraseña, sal, iteraciones, longitud, hash, algoritmo = 'AES-CBC') => {
      const encoder = new TextEncoder();
      let keyMaterial = await window.crypto.subtle.importKey(
        'raw',
        encoder.encode(contraseña),
        { name: 'PBKDF2' },
        false,
        ['deriveKey']
      );
      return await window.crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: encoder.encode(sal),
          iterations: iteraciones,
          hash
        },
        keyMaterial,
        { name: algoritmo, length: longitud },
        false,
        ['encrypt', 'decrypt']
      );
    }
    const encriptar = async (contraseña, textoPlano) => {
      const encoder = new TextEncoder();
      const sal = window.crypto.getRandomValues(new Uint8Array(LONGITUD_SAL));
      const vectorInicializacion = window.crypto.getRandomValues(new Uint8Array(LONGITUD_VECTOR_INICIALIZACION));
      const bufferTextoPlano = encoder.encode(textoPlano);
      const clave = await derivacionDeClaveBasadaEnContraseña(contraseña, sal, 100000, 256, 'SHA-256');
      const encrypted = await window.crypto.subtle.encrypt(
        { name: "AES-CBC", iv: vectorInicializacion },
        clave,
        bufferTextoPlano
      );
      return bufferABase64([
        ...sal,
        ...vectorInicializacion,
        ...new Uint8Array(encrypted)
      ]);
    };
  
    const desencriptar = async (contraseña, encriptadoEnBase64) => {
      const decoder = new TextDecoder();
      const datosEncriptados = base64ABuffer(encriptadoEnBase64);
      const sal = datosEncriptados.slice(0, LONGITUD_SAL);
      const vectorInicializacion = datosEncriptados.slice(0 + LONGITUD_SAL, LONGITUD_SAL + LONGITUD_VECTOR_INICIALIZACION);
      const clave = await derivacionDeClaveBasadaEnContraseña(contraseña, sal, 100000, 256, 'SHA-256');
      const datosDesencriptadosComoBuffer = await window.crypto.subtle.decrypt(
        { name: "AES-CBC", iv: vectorInicializacion },
        clave,
        datosEncriptados.slice(LONGITUD_SAL + LONGITUD_VECTOR_INICIALIZACION)
      );
      return decoder.decode(datosDesencriptadosComoBuffer);
    }
    $botonEncriptar.onclick = async () => {
      const contraseña = $contraseñaEncriptar.value;
      if (!contraseña) {
        return alert("No hay contraseña");
      }
      const textoPlano = $informacionEncriptar.value;
      if (!textoPlano) {
        return alert("No hay texto para encriptar");
      }
      const encriptado = await encriptar(contraseña, textoPlano);
      $resultadoEncriptacion.value = encriptado;
    };
    $botonDesencriptar.onclick = async () => {
      const contraseña = $contraseñaDesencriptar.value;
      if (!contraseña) {
        return alert("No hay contraseña");
      }
      const textoCifradoBase64 = $informacionDesencriptar.value;
      if (!textoCifradoBase64) {
        return alert("No hay texto en base64");
      }
      try {
        const desencriptado = await desencriptar(contraseña, textoCifradoBase64);
        $resultadoDesencriptacion.value = desencriptado;
      } catch (e) {
        $resultadoDesencriptacion.value = "Error desencriptando: " + e.message + ". ¿La contraseña es la correcta y la información está en base64?";
      }
    };
  
  });
</script>